StealC - Trojan/Information stealer

Some notes and take aways from how this malware comes into contact with a windows machine. 


Inital info
Created in late 2022(notating is sophistication, compared to something before 2015)
Non resiodent - malware does not intall itself permanently on the system. Sounds like tis based in injection in memory
Flexible - allows the author or C2 to customize the data being stolen. Sounds like it could be 
used as a software as a service on dark web forum purchases. (Possible UI or gui to help kiddy on hit computer)

Rated: High
Careful if the following have been associated with the malware

Mitre ATTack

TA0002(Execution)
TA0005(Defense Evasion)
TA0007(Discovery)
TA0011(Command and Control)



In regards to these 
TA0002
Command and Scripting Interpreter 
& 
Shared Modules


C & S
- After initial access, malware is trying to going about enacting command and scripts on the machine for 
further exploitation, evasion and danger
In STealc's case it uses command like tools like PS, WSH(Windows Script Host), CMD and VBS. 
JIC - Attackers leverage these to run commands that perform actions to download payloads, enact
scripts and changing or interacting with other system processes.

Command and Scripting Interpreter (T1059): Stealc can use PowerShell, CMD, or other scripting languages to run malicious scripts and commands that download and execute additional payloads or steal data.



Shared Modules

- Thinking about DLL or a system service that is used to execute additional payloads. 
- Stealc can leverage trusted processes or tools to hide the activity, avoiding detection.

Shared Modules (T1129): Stealc may make use of DLLs or system processes (such as rundll32) to execute its payload in a way that blends in with normal system operations. By using common system modules, it can evade detection and continue its operation without alerting security systems.



DEFENSIVE EVASION




TA1027(objuscated files or information)
TA1027.005(Indicator Removal from Tools)
T1112(Modify Registry)
T1620(Reflective code loading)


TA1027 

Unsure if this goes here but malware uses Opaque(had to look up) to add complectiy to the control flow.
This means
- Bad instructions are used to hide real instructions. 
- An effort to avoid hash identification and also malicuous intentions. Also
to avoid its intent and true intent when being reversed engineered 

Also we can remember that the malware configuration if encoded in base64 and then encrypted with RC4.
(if you want to go further) Somone way smart than me made a pyhton scriupt to decrypt and rename all global variables for better 
readbility in what is going on in the code.
Speaking of readability, code is written in C/C++

TA1027.005
The removal of IOC's
Note for typically how STEAlC achives this with 
- contain obfuscated stackstrings(unsure what this mean)
Exact definition - Stackstrings refer to string values (like filenames, registry keys, IP addresses, or other data) that are placed in the stack during the execution of the program. The stack is a section of memory used to store temporary variables, function parameters, and return addresses. It's often used during the runtime of a program.

T1112
- The changing or modifying windows registry to evade detection

Virus Total def (Adversaries may interact with the Windows Registry to hide configuration information within Registry keys, remove information as part of cleaning up, or as part of other techniques to aid in persistence and execution.)

T1620

VirusTotal(execute shellcode via Windows callback function)
Something to note, code is loaded in memory without touching the dish. 
possibly in ram.

Memory Allocation:

The malware allocates memory in the system's RAM to store its code. This can be done using Windows API functions like
VirtualAlloc (to allocate memory)
VirtualProtect (to change memory protection).



DISCOVERY

T1057(Process Discovery)
T1082(System Information Discovery)
T1083(File and Directory Discovery)
T1124(System Time Discovery)
T1518(Software Time Discovery)
T1518.001(Security Software Discovery)
T1614(System Location Discovery)

Allot to 

T1057
(VirusTotal) Queries a list of all running processes
A kind of nmap scan but for running processes. 
- Can query with TASKLIST
- Helps understand critical infrastructure and security tools installed.

T1082
VirusTotal 
****
query environment variable
get hostname
get disk information
Queries information about the installed CPU (vendor, model number etc)
Queries the volume information (name, serial number etc) of a device
Reads software policies
***

A more in depth look at what the machine is and any exploitable items and variables apart of the infected machine.

Editors note - prompt

Knowing system details helps attackers decide how to exploit the system, whether they can elevate privileges, and which tools or exploits might be most effective against the target environment. It also helps them to customize their attack based on the system's capabilities (e.g., a 64-bit OS might require different exploitation techniques compared to a 32-bit OS).

T1083
(VirusTotal) GET common file path

Looks like the inital step to discover important info about the user and location of important creds on the system

T1124
Potential time zone aware malware???
Kind of smart but prompt info in regards to this 

If the malware knows the local time zone or system time, it could be designed to trigger malicious activity at specific times or avoid detection during certain periods (for example, avoiding activity during normal working hours or when administrators are likely to be monitoring the system).
For example, the malware could wait until the system is in a low-traffic period (like at night or on weekends) before executing actions that could raise alarms, like exfiltrating data or communicating with its command and control (C2) server.

Also note the "Potential" use. Sounds like it can be set by the attacker 


T1518
Gather info on what software and other third partiy items are installed on the computer. 
 - information to learn about security software or vulnerable applications. 

T1518.001
Antivirus discovery, pretty explanatory.
This allows attackers On the land tools to disable, bypass and nuetrtalize and edr or antivirus control
on the computer.



T1614
get geographical location



C & C
T1071(Application Layer Protocol)
T1071.0001(Web Protocols)


T1071 
(Virus) Attackers may communicate using layer 7 to avoid detection by blending in with exisitn traffic.

Prompt breakdown(sounds like its encrypted | differenc from the RC4 encryption)
The adversary sends commands or data over an application protocol like HTTP(S), SMTP (email), or DNS. For example, an attacker might send instructions to a compromised machine using HTTP(S) requests to the C&C server, disguised as regular web traffic.

Web Protocols

Same def but more of a focus on HTTPS and secure protocols to avoid detection and to hide info provided
in the connection type

Cant see what you cant unencrpt


More info on its NETWORK COMMUNCAITION

Povided are three requests provided in:

HTTP requests
GET http://171.22.28.221/9e226a84ec50246d/sqlite3.dll 200
POST http://171.22.28.221/5c06c05b7b34e8e6.php
GET http://171.22.28.221/9e226a84ec50246d/sqlite3.dll


C&C Communication: The malware is interacting with the Command and Control server at the IP address 171.22.28.221. The use of HTTP requests (GET and POST) indicates that the C&C channel is likely disguised as legitimate web traffic to evade detection by network monitoring tools.

File Download (GET): The first and third requests are GET requests for the sqlite3.dll file. This suggests that the malware is downloading a DLL file from the C&C server, likely to execute it or use it as part of its operations on the infected system.

Data Exfiltration (POST): The POST request indicates the malware is sending data back to the attacker. This could include stolen information, system data, or even logs about the infection status. The .php extension suggests the server-side script is designed to handle the data sent from the malware.

Files deleted in this report all coorelate with 


C:\ProgramData\Microsoft\Windows\WER\Temp

This pertains to the error reporting such as:
Crash dumps: Memory dumps created when a program crashes.
Logs: Information about the error, including any system data and the specific application involved in the crash.
Metadata: Details about the system, like the operating system version and hardware configuration.



I want to go into more detail as to how mspecifically within he code avoid reverse engineering
within its schema.

1. Checks for something called VirtulAllocEXNuma Api. If in the presense of virtual memory with the check to the 
Virtual API. 
If return = 0
StealC exits

2. Accessing mw_Check_system_memory(), it calls GlobalMemoryStatusEX API. This info pertains to virtual and physical memory. 
To break down the check. Within ullTotalPhys there is a statement conmtainin
if ( !rssult && v1 < 0x457) 
	ExitProcess_(0);
	return result:

Translation: if physical memory is shifted to far to the result of 2 gb's than exit.

3. Check Windows Defender Emulation
Throught he following

- GetComputerName 
- GetUserNameA
Compares the two variables with what is provided in Windows Defender emulator

If the result matches, it will exit.

This is weird, because the names are hardcoded into how windows defender emulator works to detect malware. 

4. Expiration Check


Even weirder, there is a Check if run aftyer a set time. The code will just not run.

Achieved with GetSystemTime APi as earlier mentioned. 

When looking at the code

Its interesting to note the following snipped
if (FileTime.dwHighDateTime >= FileTime_1.dwHighDateTime )
{
 if { FileTime.dwHighTime > FileTime_1.dwHighDateTime
  || (result = FileTime.dwLowDateTime, FileTime.dwLowDateTime > FileTime_1.dwLowDateTime) ( 

{
 ExitProcess_(0):
}
return result:
}

A literal check on if the attacker sends the malware and sets the time of infecexction on that date. After infection, an investigator is unable
to launch or see the behavior of the malware after that point. 

Countermeasures:

Dynamic Time Adjustments: To bypass this expiration check, analysts can adjust the system time or simulate different system times while analyzing the malware.
Disabling Time-based Checks: Security tools could disable or mock GetSystemTime calls during analysis, forcing the malware to believe it’s running at an earlier time, so the expiration check fails.
Emulation Time Manipulation: Advanced emulation techniques can adjust or manipulate the time values returned to the malware, allowing it to bypass the expiration check.

Some other charecterisitcs that I think is interesting to note. 

Within the provided C we can see that 
For context GetUserDefaultLangId API call. When seeing this, it sounds like the malware
is being mass blasted to whoever is a vulnerable

C
v0 = GetUserDefaultLangID_() - 0x416:
 if (!V0 || (v1 = v0 - 9) == 0 || (v2 = V1 - 1) == 0 || (v3 = v2 - 0x1c)
   || (result = v3) - 4) == 0 )
     Exit Process_(0):	// 0x419   = 1049 = Russian
			// v0 - 9  --> 1058 > Ukrainian
   return result:	// v2 - 1  --> 1059 > Belarusian
}

Other items to note
- The execution of this malware.

Was a bit confused on how analysts and virus is able to analyze the virus with just a 
EXE

Seems way to explicit(amazing for reverse engineering and for reverse engineering)

When searching deeper we can see that within the execution portion of Mitre Attack, 
we can see the ways Steelc can execute itself without an EXE. 
This can be found in 

Command and Scripting Interpreter = T1059 - accept command line arguments
Shared Modules = T1129 link function at runtime on Windows | link many functions at runtime

 
